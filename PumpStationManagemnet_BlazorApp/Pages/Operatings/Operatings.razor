@page "/operatings"
@using PumpStationManagemnet_BlazorApp.DTOs
@using PumpStationManagemnet_BlazorApp.Models
@using PumpStationManagemnet_BlazorApp.Services
@using PumpStationManagemnet_BlazorApp.Enums
@inject OperatingService OperatingService
@inject PumpStationService PumpStationService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
<h3>Quản lý vận hành</h3>

<div class="mb-3">
    <div class="row">
        <div class="col-md-6">
            <input type="text" class="form-control" @bind="keyword" placeholder="Tìm kiếm theo tên máy bơm..." />
        </div>
        <div class="col-md-4">
            <InputSelect class="form-control" @bind-Value="stationId">
                <option value="">Tất cả trạm bơm</option>
                @foreach (var station in pumpStations)
                {
                    <option value="@station.StationId">@station.StationName</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary" @onclick="SearchOperatingData">Tìm kiếm</button>
        </div>
    </div>
    <a class="btn btn-success mt-2" href="/operatings/create">Thêm dữ liệu vận hành mới</a>
</div>

@if (operatingData == null)
{
    <p>Đang tải...</p>
}
else if (!operatingData.Any())
{
    <p>Không tìm thấy dữ liệu vận hành nào.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Mã</th>
                <th>Máy bơm</th>
                <th>Thời gian ghi</th>
                <th>Hiệu Suất</th>
                <th>Đánh giá</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var datum in operatingData)
            {
                <tr>
                    <td>@datum.DataId</td>
                    <td>@(datum.Pump?.PumpName ?? "N/A")</td>
                    <td>@datum.RecordTime.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@datum.Efficiency</td>
                    <td>@EnumHelper.GetDescription((OperatingStatus)datum.Status)</td>
                    <td>
                        <a class="btn btn-info btn-sm" href="/operatings/@datum.DataId">Chi tiết</a>
                        <a class="btn btn-warning btn-sm" href="/operatings/edit/@datum.DataId">Sửa</a>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteOperatingDatum(datum.DataId)">Xóa</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<OperatingData>? operatingData;
    private List<PumpStation> pumpStations = new();
    private string keyword = string.Empty;
    private int? stationId;

    protected override async Task OnInitializedAsync()
    {
        pumpStations = await PumpStationService.GetPumpStationsAsync();
        operatingData = await OperatingService.GetOperatingDataAsync();
    }

    private async Task SearchOperatingData()
    {
        operatingData = await OperatingService.GetOperatingDataAsync(keyword, stationId);
    }

    private async Task DeleteOperatingDatum(int id)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Bạn có chắc muốn xóa dữ liệu vận hành này?");
        if (confirm)
        {
            var response = await OperatingService.DeleteOperatingDatumAsync(id, 1); // Assume ModifiedBy = 1
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Xóa dữ liệu vận hành thành công!");
                operatingData = await OperatingService.GetOperatingDataAsync(keyword, stationId);
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Lỗi: {errorMessage}");
            }
        }
    }
}